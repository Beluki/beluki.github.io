

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Beluki</title>
        <link rel="stylesheet" href="/static/style.css" type="text/css">
        <link rel="stylesheet" href="/static/codehilite.css" type="text/css">
    </head>

    <body>
        <div class="top-bar">
            <ul>
                <li> <a href="/">índice</a> </li>
                <li> <a href="/archive/">archivo</a> </li>
                <li> <a href="/page/about/">acerca de</a> </li>
            </ul>
        </div>
        <div class="wrapper">
            
    

    
        
    

    
        


<div class="title">
    Cosas que aprendí de... EmbedDIBits
</div>

<div class="subtitle">
    diciembre 18, 2014

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

            
        
    </div>
</div>

<div class="content">
    <p>Aunque tras escribir Sokoban decidí crear un framework, 4k no fue el único
proyecto que nació como resultado del juego. Durante el desarrollo de 4k,
empecé dos proyectos más, dos utilidades, ambas escritas en Python.</p>
<p>La primera de las utilidades se llama EmbedXSB. Traduce niveles de Sokoban
en formato <a href="http://sokosolve.sourceforge.net/FileFormatXSB.html">XSB</a> a cabeceras de C. Como la cabecera resultado es específica
para Sokoban 4k (diseñada para ocupar lo menos posible), no llegué nunca
a limpiar y mejorar el programa y publicarlo en Github. EmbedXSB me permitió
incluír los 50 niveles originales de Sokoban en Sokoban 4k.</p>
<p>La segunda se llama <a href="https://github.com/Beluki/EmbedDIBits">EmbedDIBits</a>. Lee imágenes en formato PNG, BMP, JPG...
y crea cabeceras de C con un array de bytes que contiene el color de cada
pixel, en formato: 0xAARRGGBB, 32 bits. La idea es poder tomar los sprites
originales de Sokoban y tenerlos directamente en C, sin ningún tipo de archivo
intermedio.</p>
<h2>Python</h2>
<p>En su momento escribí EmbedXSB y EmbedDIBits en Python 2. EmbedDIBits usaba
<a href="http://www.pythonware.com/products/pil/">PIL</a> para leer las imágenes. Con el tiempo, porté EmbedDIBits a Python 3
y cambié de PIL a <a href="http://pillow.readthedocs.org">Pillow</a>, dado que PIL lleva años sin actualizarse y no
soporta Python 3.</p>
<p>Mi experiencia con el lenguaje y las librerías es excelente. Cosas como parsear
opciones de línea de comandos (en plan "--help" o "--option bla") son muy fáciles
de hacer con argparse. Construcciones como "with open(...)", que cierran
automáticamente un archivo tras utilizarlo, son prácticas. Portar de Python 2
a Python 3 fue trivial, aunque también es cierto que EmbedDIBits es un programa
muy pequeño y simple.</p>
<p>De quejarme de algo sería de la conversión automática de finales de línea
dependiendo de la plataforma actual en la que se ejecuta el código:</p>
<div class="codehilite"><pre><span class="c"># texto\n en Unix</span>
<span class="c"># texto\r\n en Windows</span>
<span class="c"># texto\r en Mac OS</span>
<span class="k">print</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span>

<span class="c"># el final de línea que quieras, pero ha de ser en bytes:</span>
<span class="n">eol</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">texto</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">eol</span><span class="p">)</span>
</pre></div>


<p>Me quejo porque tengo la costumbre de permitir al usuario especificar cualquier
final de línea que desee ("--newline formato" en EmbedDIBits). Mi opinión es que
un programa realmente portable debe comportarse igual en todas las plataformas
y la salida que produce ha ser idéntica y reproducible.</p>
<h2>Utilidades de consola</h2>
<p>Quizá la mejor lección que aprendí de EmbedDIBits es a respetar y tener en cuenta
todo aquello que un usuario experimentado espera del comportamiento de un programa
de consola. Algunos ejemplos al respecto:</p>
<ul>
<li>Usa el programa stdout/stderr correctamente?</li>
<li>Provee --help? Son el resto de opciones fáciles de entender por su descripción?</li>
<li>Si produce archivos... puede imprimir su salida también por stdout?</li>
<li>Puede redirigirse su stdout/stderr fácilmente?</li>
<li>Está pensado para combinarse con otras herramientas? (por ejemplo: grep)</li>
<li>Devuelve 0 o otro valor al terminar dependiendo de si ha habido errores?</li>
<li>Entiende nombres de archivos con espacios? con carácteres UTF-8?</li>
<li>Si la tarea que ha de realizar es larga: provee feedback adecuado al usuario?</li>
<li>Tiene alguna opción para suprimir estos mensajes cuando no son necesarios?</li>
</ul>
<p>Hay mucho más detrás de lo que parece (para variar) y es fácil olvidarse
de las cosas. Ahora, cada vez que empiezo un programa nuevo, reviso todo esto
y me guío por los que ya he hecho para mantener un standard aceptable.</p>
<h2>Conclusiones</h2>
<p>Lo que más me llama la atención de todo esto es que un proyecto relativamente
pequeño, como Sokoban 4k, puede dar lugar al nacimiento de otros 3 proyectos más.</p>
<p>Este patrón se ha vuelto común en mí. Es además una manera cómoda de testear
bien mis librerías, programas, etc..., porque cada proyecto depende de otros.
Al final todos se testean mutuamente.</p>
<p>Repositorios en Github: <a href="https://github.com/Beluki/EmbedDIBits">EmbedDIBits</a></p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-EmbedDIBits/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-EmbedDIBits/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cosas que aprendí de... 4k
</div>

<div class="subtitle">
    diciembre 10, 2014

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

            
        
    </div>
</div>

<div class="content">
    <p>Me he mudado hace unas semanas. El caso es, que con todo el trajín, mis proyectos
han pasado a un segundo plano. Como también tengo este blog un tanto abandonado,
creo que un buen modo de volver a retomarlos es escribir unos cuantos post acerca de
ellos. Hablar de las cosas que salieron bien y las que no tan bien, decisiones de
diseño, etc...</p>
<h2>Sokoban</h2>
<p>Hace ya un par de años, escribí un clon de <a href="http://es.wikipedia.org/wiki/Sokoban">Sokoban</a> en C. La idea era hacerlo
en 4 kilobytes (un .exe de no más de 4096 bytes) al estilo de lo que hacen los
grupos en la <a href="http://es.wikipedia.org/wiki/Demoscene">Demoscene</a> o la gente de <a href="http://www.java4k.com/index.php?action=home">Java4k</a>.</p>
<p>Sokoban es un juego con unas reglas extremadamente simples, así que parecía el
candidato ideal. El producto final, aunque sin sonido, tenía gráficos decentes
(con la paleta CGA de Sokoban de MS-DOS) y los 50 niveles originales. Recuerdo
la experiencia como frustrante, intentando sacar bytes de cualquier parte,
pero divertida.</p>
<p>Una anécdota es que el código de dibujar el nivel y el de comprobar si se ha
resuelto estaba mezclado en un solo bucle y ambos se hacían a la vez.</p>
<h2>Una base común</h2>
<p>Tras escribir Sokoban pensé que algo útil sería tener un framework, una especie
de plantilla con una base común reutilizable para demos o juegos de 4 kb. En un
alarde de originalidad, decidí llamar al proyecto... 4k.</p>
<p>Lo primero que aprendí es que es difícil definir una base común.</p>
<p>Los juegos necesitan control de teclado y ratón, las demos no. Las demos suelen
verse a pantalla completa, los juegos en una ventana. Para un juego simple, 2D
via <a href="http://es.wikipedia.org/wiki/Graphics_Device_Interface">GDI</a> es más que suficiente, las demos a menudo usan <a href="http://es.wikipedia.org/wiki/OpenGL">OpenGL</a> o <a href="http://es.wikipedia.org/wiki/DirectX">DirectX</a>.</p>
<p>Al final, definí la base común como:</p>
<ul>
<li>Crear una ventana con una resolución arbitraria.</li>
<li>Un bucle (game loop) que funcione a una velocidad constante.</li>
<li>Poder dibujar en la ventana con doble buffer.</li>
</ul>
<p>Muchos juegos (especialmente los que caben en 4k), son más cómodos en ventana.
A pantalla completa, hay que preocuparse además de cosas como el aspect ratio
o la tasa de refresco de cada monitor. Aunque ambos pueden autodetectarse
decidí escoger el camino más simple.</p>
<p>El bucle es también el más simple posible. Se asume que todo PC puede ejecutar
la demo a la tasa de frames requerida sin problemas de rendimiento. Ni siquiera
se separa la lógica/renderizado, todo se actualiza a la misma velocidad. Para un
ejemplo de lo que puede complicarse un gameloop, lee <a href="http://gafferongames.com/game-physics/fix-your-timestep/">Fix Your Timestep!</a>. En
la práctica, para juegos sencillos, el bucle más simple es perfectamente usable.</p>
<p>Decidí no añadir nada para controlar el teclado. En ese punto... ¿por qué no ratón
y joystick?. Muchas demos no necesitan ninguno de ellos. Muchos juegos solo usan
uno de entre todos.</p>
<p>Finalmente, en lugar de hacer una plantilla, hice dos: una GDI y otra OpenGL.</p>
<h2>Sin librería standard</h2>
<p>En 4k no hay suficiente espacio para usar la librería de C. No hay malloc()
o rand(). Lo cierto es que no tener ninguna de estas funciones no
supuso un problema, ni en las demos de ejemplo que hice para 4k ni en Sokoban.
Normalmente, recrear lo que se necesita es fácil.</p>
<p>De elegir algo problemático, sería lo de siempre: C. Cada vez estoy más
convencido de que usar lenguajes donde un error puede pasar completamente
inadvertido es una mala idea, incluso para programas tan pequeños como 4k.</p>
<p>Tener excepciones también ayudaría a que el código que controla errores
no fuese tan extremadamente repetitivo al tener que comprobar manualmente
cada valor de retorno.</p>
<p>Algo que lo que sin embargo no me quejo es de la API de Windows (al menos de
las partes que he usado para 4k). Está bien documentada, es razonablemente
simple y funciona. <a href="http://es.wikipedia.org/wiki/Xlib">Xlib</a> es mucho más coñazo.</p>
<p>Tampoco me quejo de la portabilidad entre compiladores y arquitecturas.
El código compila sin cambios en todas las versiones que he podido testear
de MSVC, GCC y Clang, tanto en 32 como en 64 bit.</p>
<h2>Demos</h2>
<p><img src="/static/9.png" alt="demos"></p>
<p>No había mejor modo de testear 4k que usándolo para hacer una demo simple.
En ambos casos (GDI y OpenGL), elegí algo que pudiese crearse combinando
las cosas más primitivas de la API: rectángulos en GDI, cubos en OpenGL.</p>
<p>Otra de las restricciones era que la demo debería funcionar correctamente
a cualquier tamaño de ventana y a cualquier tasa de frames por segundo, lo
que haría más fácil testear.</p>
<h2>Conclusiones</h2>
<p>Lo que pasa por mi cabeza al recordar el proyecto es que me parece increíble
que haga falta tanta historia para dibujar unos cuantos rectángulos.</p>
<p>Creo que si hubiese nacido en el 2000, nunca habría aprendido a programar.
Los sistemas operativos ya no incluyen herramientas para ello por defecto.
Falta esa inmediatez de tener siempre un QBasic a mano para trastear, donde
hacer el equivalente a 4k-example son unas 10 líneas.</p>
<p>Es cierto que hoy los sistemas operativos y en general los programas hacen
cosas mucho más complejas que entonces. Hemos avanzado una barbaridad. Quizá
sea la nostalgia, pero tengo la sensación de que en algún punto entre todo este
progreso, se perdió algo importante.</p>
<p>Repositorios en Github: <a href="https://github.com/Beluki/4k">4k</a> - <a href="https://github.com/Beluki/4k-Example">4k-Example</a> - <a href="https://github.com/Beluki/4kGL">4kGL</a> - <a href="https://github.com/Beluki/4kGL-Example">4kGL-Example</a></p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-4k/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-4k/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Stack Overflow
</div>

<div class="subtitle">
    marzo 06, 2014

    <div class="multilink">
        
            <a href="/archive/programacion/">programación</a>

            
        
    </div>
</div>

<div class="content">
    <p>Leo una <a href="http://stackoverflow.com/questions/62188/stack-overflow-code-golf">entrada en Stack Overflow</a> conmemorando su lanzamiento en la que
el autor invita a los usuarios a crear el programa más pequeño posible
que pueda causar un error de <a href="http://en.wikipedia.org/wiki/Stack_overflow">stack overflow</a>.</p>
<p>He aquí una posible solución. No es pequeña, pero es interesante. Es algo
que puede ocurrir en el uso diario y que provoca un stack overflow en
casi todas las implementaciones de lenguajes que conozco.</p>
<p>La idea es tan simple como crear dos estructuras de datos extremadamente
profundas y comprobar su igualdad. El siguiente ejemplo usa listas en Python.</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">deep_list</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">deep_list</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="o">==</span> <span class="n">deep_list</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">maximum</span> <span class="n">recursion</span> <span class="n">depth</span> <span class="n">exceeded</span> <span class="ow">in</span> <span class="n">comparison</span>
</pre></div>


<p>La mayoría de implementaciones tienen en cuenta la longitud de las estructuras
de datos a la hora de escribir el código que las compara, pero no su
profundidad. El mismo código produce un stack overflow en las implementaciones
actuales de Ruby, Lua, C#, Java y muchos otros lenguajes.</p>
<p>Lo mismo, escrito en Scheme y ejecutado en <a href="http://sisc-scheme.org">SISC</a>.</p>
<div class="codehilite"><pre><span class="nv">&gt;</span> <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">deep-list</span> <span class="nv">n</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">ls</span> <span class="o">&#39;</span><span class="p">())</span> <span class="p">(</span><span class="nf">n</span> <span class="nv">n</span><span class="p">))</span>
          <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
              <span class="nv">ls</span>
              <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">ls</span> <span class="o">&#39;</span><span class="p">())</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)))))</span>

<span class="nv">&gt;</span> <span class="p">(</span><span class="nb">equal? </span><span class="p">(</span><span class="nf">deep-list</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">(</span><span class="nf">deep-list</span> <span class="mi">10000</span><span class="p">))</span>
<span class="nv">Exception</span> <span class="nv">in</span> <span class="nv">thread</span> <span class="s">&quot;main&quot;</span> <span class="nv">java</span><span class="o">.</span><span class="nv">lang</span><span class="o">.</span><span class="nv">StackOverflowError</span>
  <span class="nv">at</span> <span class="nv">sisc</span><span class="o">.</span><span class="nv">data</span><span class="o">.</span><span class="nv">Pair</span><span class="o">.</span><span class="nv">car</span><span class="p">(</span><span class="nf">Unknown</span> <span class="nv">Source</span><span class="p">)</span>
  <span class="nv">at</span> <span class="nv">sisc</span><span class="o">.</span><span class="nv">data</span><span class="o">.</span><span class="nv">Pair</span><span class="o">.</span><span class="nv">valueEqual</span><span class="p">(</span><span class="nf">Unknown</span> <span class="nv">Source</span><span class="p">)</span>
  <span class="nv">at</span> <span class="nv">sisc</span><span class="o">.</span><span class="nv">data</span><span class="o">.</span><span class="nv">Pair</span><span class="o">.</span><span class="nv">valueEqual</span><span class="p">(</span><span class="nf">Unknown</span> <span class="nv">Source</span><span class="p">)</span>
  <span class="o">...</span>
</pre></div>


<p>Dos excepciones notables: <a href="http://s48.org">Scheme48</a> y <a href="http://racket-lang.org">Racket</a> soportan listas
de profundidad arbitraria, únicamente limitadas por la cantidad
de memoria disponible en el sistema.</p>
</div>


        <div class="multilink">
            <a href="/post/stack-overflow/">permalink</a> |
            <a href="/post/stack-overflow/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cine mudo
</div>

<div class="subtitle">
    octubre 20, 2013

    <div class="multilink">
        
            <a href="/archive/poesia/">poesía</a>

            
        
    </div>
</div>

<div class="content">
    <pre class="poetry">
    La tarde se debatía,
    entre el tedio y la pereza,
    qué hastío, qué aburrimiento,
    qué sopor y qué paciencia.

    ¿Y si vemos una peli?
    ¿Cuál quieres ver? ¿en qué piensas?
    Yo que mucho no pensaba,
    hice que le daba vueltas.

    Cariño, te va a salir,
    el humo por las orejas.
    Una neurona me dijo,
    que se declaraba en huelga.

    Esto pasa por robarle,
    horas de más a la siesta.
    Yo qué sé, elige tú,
    a mí me vale cualquiera.

    ¿Una de acción? ¿quizá un drama?
    ¿De terror? ¿una comedia?
    ¿Un cuento de los de antes,
    de príncipes y princesas?

    De alcobas, de torreones,
    de caballeros y trenzas,
    un malo que sea tan malo,
    que demuestre inteligencia.

    Buscadores de tesoros,
    romances, de cenicientas,
    un guión enrevesado,
    que sepa dejarte a medias.

    De piratas y motines,
    enanitos y doncellas,
    con soldaditos de plomo
    y mágicas habichuelas.

    Un perro que sepa hablar,
    una sirena sin lengua,
    con casitas de jengibre,
    conejos y madrigueras.

    Con un anciano hechicero,
    un niño que nunca crezca,
    una lámpara encantada,
    ladrones... unos cuarenta.

    Un cuento de los de siempre,
    que acabe con moraleja,
    de esos que solo hay,
    ahora en las bibliotecas.

    No supe qué contestar,
    ¡menuda lluvia de ideas!
    No te preocupes, tranquilo,
    que yo te doy la respuesta.

    De frente se me acercó,
    a un milímetro, muy cerca,
    plantándome un beso enorme,
    rodado a cámara lenta.

    Un crítico hubiese dicho,
    que fue toda una proeza,
    que era toda la cosa,
    un solo plano secuencia.

    Sin pensármelo le dije:
    Yo quiero volver a verla.
</pre>

<p>Otro poema, quizá un tanto largo para ponerlo aquí.</p>
<p>Si has llegado al final, te propongo un juego. ¿Puedes encontrar todas
las referencias a cuentos infantiles que hay en el poema? Por ejemplo:
"casitas de jengibre" es una referencia a <a href="http://es.wikipedia.org/wiki/Hansel_y_Gretel">Hansel y Gretel</a>.</p>
</div>


        <div class="multilink">
            <a href="/post/cine-mudo/">permalink</a> |
            <a href="/post/cine-mudo/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    The shocking Miss Emerald
</div>

<div class="subtitle">
    octubre 19, 2013

    <div class="multilink">
        
            <a href="/archive/musica/">música</a>

            
        
    </div>
</div>

<div class="content">
    <p><img src="/static/8.png" alt="cover"></p>
<p>Hacía tiempo que un grupo (o un artista) no me enganchaba tanto. Si no
has escuchado ya algo de Caro, estás <a href="http://www.youtube.com/watch?v=6QUmPZmkr4I">tardando</a> en hacerlo. Qué voz.
Aún no tengo claro si es jazz, tango, swing o qué, pero el caso es
que la mezcla funciona a la perfección.</p>
</div>


        <div class="multilink">
            <a href="/post/the-shocking-miss-emerald/">permalink</a> |
            <a href="/post/the-shocking-miss-emerald/#disqus_thread">comentarios</a>
        </div>
    

    
        <div class="prevnext">
            <ul>
                
                    <li> <a href="/">&laquo; siguiente</a> </li>
                

                
                    <li> <a href="/3/">anterior &raquo;</a> </li>
                
            </ul>
        </div>
    

        </div>
    </body>
</html>
