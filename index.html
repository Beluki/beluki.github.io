

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Beluki</title>
        <link rel="stylesheet" href="/static/style.css" type="text/css">
        <link rel="stylesheet" href="/static/codehilite.css" type="text/css">
    </head>

    <body>
        <div class="top-bar">
            <ul>
                <li> <a href="/">índice</a> </li>
                <li> <a href="/archive/">archivo</a> </li>
                <li> <a href="/page/about/">acerca de</a> </li>
            </ul>
        </div>
        <div class="wrapper">
            
    

    
        
    

    
        


<div class="title">
    Cosas que aprendí de... Yava
</div>

<div class="subtitle">
    diciembre 19, 2015

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

            
        
    </div>
</div>

<div class="content">
    <p><a href="https://github.com/Beluki/Yava">Yava</a> es un lanzador de aplicaciones escrito en C#, pensado para ser usado
principalmente con emuladores como <a href="https://dolphin-emu.org">Dolphin</a>, <a href="http://mamedev.org">Mame</a>, <a href="http://snes9x.ipherswipsite.com">Snes9x</a>, etc...
Es un pequeño menú desde el que ejecutar los juegos de una manera cómoda y rápida.</p>
<p>Tiene esta pinta:</p>
<p><img src="/static/17.png" alt="Yava"></p>
<p>Aunque ya existen muchos programas parecidos (como <a href="https://www.launchbox-app.com">LaunchBox</a> o <a href="http://www.mgalaxy.com">mGalaxy</a>) no pude
encontrar ninguno que cumpliese los siguientes requisitos:</p>
<ul>
<li>Fuese portable (funcione desde un pincho USB).</li>
<li>No utilice una base de datos interna, solo carpetas y archivos.</li>
<li>Sea fácil de configurar, preferiblemente en un solo archivo.</li>
<li>Solo ejecute los juegos, delegando el resto del trabajo a cada emulador.</li>
</ul>
<h2>Arquitectura</h2>
<p>Yava es prácticamente idéntico a <a href="http://beluki.github.io/post/cosas-que-aprendi-de-GaGa">GaGa</a> en diseño.</p>
<p><img src="/static/18.png" alt="Yava"></p>
<p>Usa las mismas librerías: <a href="https://github.com/Beluki/mINI">mINI</a> y <a href="https://github.com/Beluki/LowKey">LowKey</a>. Los componentes son también
los mismos, excepto que no existe el concepto de Player (no hay reproductor)
y StreamsFile es ahora FoldersFile, que es el fichero donde reside la configuración
de todos los juegos/emuladores.</p>
<p>Las únicas partes complicadas del código de Yava son probablemente el código que se
encarga de recordar qué rom está seleccionada para cada carpeta (líneas 276 en
adelante en <a href="https://github.com/Beluki/Yava/blob/master/Source/Yava/Yava.cs#L276">Yava.cs</a>) y lo relativo a ejecutar el emulador final pasándole la ruta
correcta de la carpeta donde está.</p>
<h2>Paths</h2>
<p>¿No es tan complicado, no? Solo es ejecutar el emulador + la rom. El problema es
que no hay una ruta correcta, sino múltiples rutas que pueden ser absolutas o relativas.</p>
<p>Por ejemplo, si el archivo Folders.ini contiene...</p>
<div class="codehilite"><pre><span class="k">[Wii]</span>
<span class="na">path</span> <span class="o">=</span> <span class="s">Romset\Wii</span>
<span class="na">executable</span> <span class="o">=</span> <span class="s">Emulators\Dolphin 4.0.3\Play\Dolphin.exe</span>
<span class="na">parameters</span> <span class="o">=</span> <span class="s">--batch --exec &quot;%FILEPATH%&quot;</span>
<span class="na">extensions</span> <span class="o">=</span> <span class="s">iso, wbfs</span>
</pre></div>


<p>Entonces:</p>
<ul>
<li>
<p>"path" es una ruta relativa o absoluta a la carpeta donde están las roms de Wii.</p>
</li>
<li>
<p>"executable" es una ruta relativa o absoluta a la carpeta donde reside el emulador, Dolphin.</p>
</li>
<li>
<p>"parameters" contiene los argumentos a pasarle a Dolphin, donde el %FILEPATH% es la ROM a usar.</p>
</li>
</ul>
<h2>Dos curiosidades</h2>
<p>¿Cuál es el rendimiento que cabe esperar de un programa como Yava? Según mis pruebas
tarda menos de 1 segundo en cargar las más de 45.000 roms de Mame directamente del
sistema de archivos, sin base de datos ni nada. Buscar es instantáneo.</p>
<p>¿Qué ocurre si configuramos el archivo Folders.ini así?</p>
<div class="codehilite"><pre><span class="k">[Snes]</span>
<span class="na">path</span> <span class="o">=</span> <span class="s">Romset\Snes</span>
<span class="na">executable</span> <span class="o">=</span> <span class="s">%FILEPATH%</span>
<span class="na">extensions</span> <span class="o">=</span> <span class="s">smc</span>
</pre></div>


<p>Yava intentará abrir las roms con extensión .smc con la aplicación asociada a ellas
por defecto (sea el emulador que sea). Es posible hacer esto para cualquier extensión.</p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-Yava/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-Yava/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cosas que aprendí de... MovieWar
</div>

<div class="subtitle">
    diciembre 18, 2015

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

             | 
        
            <a href="/archive/python/">python</a>

            
        
    </div>
</div>

<div class="content">
    <p><a href="https://github.com/Beluki/MovieWar">MovieWar</a> es un trivial multijugador para consola escrito en Python. Es parecido
a "<a href="https://es.wikipedia.org/wiki/The_Price_is_Right">El precio justo</a>", donde los jugadores intentan adivinar la fecha de salida
de una película a partir de su título.</p>
<p>He aquí una foto:</p>
<p><img src="/static/16.png" alt="MovieWar"></p>
<p>Algunas características interesantes del programa:</p>
<ul>
<li>Singleplayer o multiplayer (cualquier número de jugadores, por turnos).</li>
<li>Incluye más de 7600 películas populares en la base de datos.</li>
<li>Dos modos de juego: "película aleatoria" o "un jugador escoge y el resto adivinan fecha".</li>
<li>Usa <a href="http://www.omdbapi.com">OMDB</a> para buscar películas que desconoce y actualiza la DB con las entradas nuevas.</li>
<li>Soporte de colores opcional, utilizando <a href="https://pypi.python.org/pypi/colorama">Colorama</a>.</li>
</ul>
<h2>La base de datos</h2>
<p>MovieWar es un programa simple, secuencial, basado en turnos. La entrada/salida
de cada paso está claramente definida. El código son unas 700 líneas. La parte
complicada consiste en responder a la siguiente pregunta:</p>
<p>¿Cómo genero una buena base de datos de películas populares para poder jugar?</p>
<p>Mi respuesta fue: utilizando múltiples bases de datos y verificando que todo
coincide antes de añadir ninguna película. Para ello, creé una serie de scripts,
<a href="https://github.com/Beluki/MovieWarDBGen">MovieWarDBGen</a> en un repositorio aparte que se encargan de todo el proceso.</p>
<h2>The Movie List</h2>
<p>El punto de partida para la base de datos es una lista de 9200 películas que
<a href="http://www.nytimes.com/2010/04/18/movies/18bourland.html?_r=1">Brad Bourland</a> recopiló durante años. Esta lista es un "top 9200" y solo
contiene películas anteriores al año 2000. Esto es ideal porque permite verificar
fácilmente el año de salida de cada película con respecto a múltiples bases de datos
y  son películas razonablemente populares (no hay Bollywood ni nada por el estilo).</p>
<p>El <a href="https://github.com/Beluki/MovieWarDBGen/blob/master/Source/00%20download%20freebase.py">primer script</a> de MovieWarDBGen, usa la API de Freebase para descargar la lista
completa. El <a href="https://github.com/Beluki/MovieWarDBGen/blob/master/Source/01%20convert%20freebase.py">segundo</a>, convierte los datos a un formato más simple, validando el título
y fecha en el proceso.</p>
<p>El <a href="https://github.com/Beluki/MovieWarDBGen/blob/master/Source/02%20match%20omdb.py">tercero</a>, utiliza <a href="http://www.omdbapi.com">OMDB</a> para verificar que todas las fechas de salida y títulos
de Freebase coinciden con el esperado en OMDB. De 9169 películas, 7616 concuerdan exactamente
en ambas bases de datos. Este script puede tardar tranquilamente 2 horas en ejecutarse, pero
mejor calidad que cantidad.</p>
<p>Un <a href="https://github.com/Beluki/MovieWarDBGen/blob/master/Source/03%20collapse%20years.py">cuarto</a> script se encarga de colapsar los años de películas que tienen el mismo título
en una sola entrada JSON. Por ejemplo, convierte esto:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane Eyre&quot;</span><span class="p">,</span> <span class="nt">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;2011&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane Eyre&quot;</span><span class="p">,</span> <span class="nt">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;1996&quot;</span><span class="p">}</span>
</pre></div>


<p>En esto otro:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane Eyre&quot;</span><span class="p">,</span> <span class="nt">&quot;years&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2011&quot;</span><span class="p">,</span> <span class="s2">&quot;1996&quot;</span><span class="p">]}</span>
</pre></div>


<p>También comprueba años duplicados.</p>
<h2>Puntuando</h2>
<p>Una vez la base de datos está lista, implementar el juego es fácil.
La única decisión curiosa que toma MovieWar está en cómo puntuar las respuestas
de los jugadores:</p>
<p>MovieWar da 50 puntos por una respuesta exacta y (20 puntos - años de error) por un fallo.
Esto garantiza que la cosa esté un poco reñida al final, debido a penalizaciones
y que cada jugador suele ser experto en diferentes géneros de cine.</p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-MovieWar/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-MovieWar/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cosas que aprendí de... 404
</div>

<div class="subtitle">
    diciembre 17, 2015

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

             | 
        
            <a href="/archive/python/">python</a>

            
        
    </div>
</div>

<div class="content">
    <p><a href="https://github.com/Beluki/404">404</a> es un pequeño programa escrito en Python que permite comprobar el estado
de una serie de enlaces en una página web.</p>
<p>Un ejemplo:</p>
<div class="codehilite"><pre>$ 404.py http://beluki.github.io --threads <span class="m">10</span> --internal follow --external check
404: http://cdimage.debian.org/debian-cd/7.8.0/i386/iso-cd/
Checked <span class="m">181</span> total links in 10.4 seconds.
<span class="m">55</span> internal, <span class="m">126</span> external.
<span class="m">0</span> network/parsing errors, <span class="m">1</span> link errors.
</pre></div>


<p>Todo empezó probando un lenguaje de programación llamado <a href="http://nim-lang.org">Nim</a>, en el que
implementé un script <a href="https://github.com/nim-lang/Nim/issues/2650">parecido</a> para testear la librería standard. Frustrado con
múltiples bugs, decidí plantarme y reescribirlo en Python en lugar de Nim y <a href="https://github.com/Beluki/404">404</a>
fue el resultado.</p>
<h2>Arquitectura</h2>
<p>404 sigue la misma arquitectura exacta que <a href="https://github.com/Beluki/MultiHash">MultiHash</a>. Usa el mismo código para crear
su threadpool y mantener los hilos. Ya <a href="http://beluki.github.io/post/respuesta-inmediata-con-multiples-hilos/">escribí un post</a> sobre ello en este blog. Una
vez creado, el resto es cuestión de utilizar <a href="http://www.crummy.com/software/BeautifulSoup">BeautifulSoup</a> para leer el HTML y
<a href="http://docs.python-requests.org/en/latest">Requests</a> para ir acumulando el resto de los enlaces.</p>
<p>Lo cierto es que la mayoría del trabajo lo hacen las dos librerías. BeautifulSoup
ya se encarga de escoger el mejor parser de HTML existente en el sistema y es flexible
con respecto al código en si.</p>
<p>Por eficiencia, 404 solo tiene en cuenta enlaces &lt;a href... e &lt;img src...</p>
<div class="codehilite"><pre><span class="n">link_strainer</span> <span class="o">=</span> <span class="n">SoupStrainer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;img&#39;</span><span class="p">)</span>

<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">,</span> <span class="n">parse_only</span> <span class="o">=</span> <span class="n">link_strainer</span><span class="p">,</span>
                        <span class="n">from_encoding</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

<span class="c1"># a href...</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">href</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># img src...</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>


<p>Del mismo modo, Requests se encarga de todo lo necesario para establecer la
comunicación entre 404 y los servidores. Soporta <a href="http://docs.python-requests.org/en/latest/user/advanced/#ssl-cert-verification">SSL</a>, <a href="http://docs.python-requests.org/en/latest/user/quickstart/#redirection-and-history">redirecciones</a>,
<a href="http://docs.python-requests.org/en/latest/user/quickstart/#timeouts">Timeouts</a> y un montón de cosas más que 404 no necesita. Sin estas dos librerías,
es probable que el código de 404 fuese tranquilamente diez o quince veces más largo y complejo.</p>
<p>La única optimización que hace 404 es ignorar la parte <a href="https://en.wikipedia.org/wiki/Fragment_identifier">fragment</a> de los enlaces
antes de pasar cada link al resto del programa, dado que solo tiene sentido para
el navegador.</p>
<p>Una pregunta interesante es: ¿qué se considera un error al comprobar un enlace?
¿estado 404? ¿estado 301 (movido permanentemente)?. Para 404 la respuesta es:
hay un error cuando por problemas de conexión o de lectura (imposible leer el HTML)
no se puede obtener un código de estado válido en un tiempo aceptable.</p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-404/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-404/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cosas que aprendí de... dir
</div>

<div class="subtitle">
    diciembre 15, 2015

    <div class="multilink">
        
            <a href="/archive/lua/">lua</a>

             | 
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

            
        
    </div>
</div>

<div class="content">
    <p><a href="https://github.com/Beluki/dir">dir</a> es un videojuego multiplataforma escrito en <a href="http://www.lua.org">Lua</a> que utiliza el
framework <a href="https://love2d.org">Löve2D</a>. El estilo de juego es parecido a Bejeweled o Tetris:
juntar piezas de un mismo color para que desaparezcan.</p>
<p>Es también mi intento de diseñar un juego que resulte atractivo a audiencias
casuales y hardcore, sin depender de límites de tiempo o reflejos rápidos.</p>
<p>Tiene esta pinta:</p>
<p><img src="/static/15.png" alt="dir"></p>
<p>Si quieres descargarlo y echar una partida antes de continuar leyendo
<a href="https://github.com/Beluki/dir/releases">haz click aquí</a>.</p>
<h2>Características</h2>
<p><a href="https://github.com/Beluki/dir">dir</a> podría definirse tanto por las cosas que sí tiene:</p>
<ul>
<li>Una mecánica original, basada en acumular combos.</li>
<li>Altamente rejugable. Una partida completa dura entre 5 y 15 minutos.</li>
<li>Sistema de puntuación y ranking altamente depurado.</li>
<li>El juego es completamente independiente de la resolución, dado que dibuja
todas las piezas vectorialmente. Todo en <a href="https://github.com/Beluki/dir">dir</a> es o bien un cuadrado o bien un trozo de texto.</li>
<li>Tres temas de colores.</li>
<li>Portable. No utiliza el registro de Windows, ni la carpeta Mis Documentos, etc...</li>
</ul>
<p>... como por las que no:</p>
<ul>
<li>Una pantalla de título.</li>
<li>Múltiples niveles de dificultad.</li>
<li>Múltiples modos de juego.</li>
<li>Cargar o Guardar partida.</li>
<li>Sonido o música.</li>
<li>Límite de puntuación o final.</li>
<li>Pantalla de "game over".</li>
</ul>
<h2>Löve2D</h2>
<p>Antes de empezar a programar el juego, evalué múltiples frameworks como posibles
candidatos. Los principales fueron <a href="http://haxe.org">Haxe</a>, <a href="https://love2d.org">Löve2D</a>, <a href="http://www.monogame.net">Monogame</a> y <a href="http://pygame.org/hifi.html">pygame</a>.</p>
<p>Dos de ellos, Monogame y pygame, los descarté en parte por sus dependencias (<a href="http://www.microsoft.com/net">.NET</a> y <a href="https://www.python.org">Python</a>
respectivamente) y en parte por <a href="http://stackoverflow.com/questions/23305577/draw-rectangle-in-monogame">complicaciones</a>
a la hora de hacer tareas que deberían ser realmente simples, como dibujar un cuadrado en pantalla.</p>
<p>En el caso de Haxe, las incompatibilidades entre la versión web y la versión
escritorio fueron la principal razón de descartarlo. Basta con echar un ojo
a la demo de <a href="http://www.joshuagranick.com/2012/02/22/nme-game-example-pirate-pig">PiratePig</a> en el blog de Joshua Granick para darse cuenta de
las diferencias (compara por ejemplo la versión HTML5 y Flash).</p>
<p>A día de hoy no sé si puedo decir que Löve fuese el framework "perfecto", pero
volvería a utilizarlo para programar <a href="https://github.com/Beluki/dir">dir</a>. La <a href="https://love2d.org/wiki/Main_Page">documentación</a>
es excelente. El <a href="https://love2d.org/forums/">foro</a> también.</p>
<h2>Lua</h2>
<p>Utilizar Löve2D implica utilizar Lua.</p>
<p>Lua es en general un lenguaje muy bien diseñado con alguna que otra pega
importante, aunque todas las pegas tienen sentido en el contexto donde Lua
suele utilizarse.</p>
<p>Por ejemplo: Lua no tiene una librería standard decente, no tiene excepciones,
no tiene orientación a objetos, no tiene mil cosas que normalmente son necesarias
cuando no estás programando algo embebido. Löve2D suple en parte la falta de esta
funcionalidad a base de módulos adicionales como "love.audio", "love.filesystem",
etc...</p>
<p>Lua tampoco tiene un modo de distinguir "nil" de "variable no inicializada", lo cual
me ha causado muchos más dolores de cabeza a la hora de programar dir que cualquier
módulo aparte que haya tenido que escribir.</p>
<h2>Arquitectura</h2>
<p><a href="https://github.com/Beluki/dir">dir</a> está escrito de modo que <a href="https://github.com/Beluki/dir/tree/master/Source">cada parte</a> es lo más independiente posible de todas
las demás. Cada componente usa además su propia noción de orientación a objetos (closures
en realidad), con un "self" explícito al estilo Python.</p>
<p>Por ejemplo, para inicializar el juego:</p>
<div class="codehilite"><pre><span class="k">function</span> <span class="nf">Game</span> <span class="p">()</span>
    <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">-- initialization:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="n">self</span><span class="p">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hud</span> <span class="o">=</span> <span class="n">Hud</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="n">Screen</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">theme</span> <span class="o">=</span> <span class="n">Theme</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">resize</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">restart</span><span class="p">()</span>
    <span class="k">end</span>

    <span class="c1">-- otros &quot;métodos&quot;...</span>

    <span class="n">self</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">self</span>
<span class="k">end</span>
</pre></div>


<p>donde <a href="https://github.com/Beluki/dir/blob/master/Source/game/grid.lua">Grid</a>, <a href="https://github.com/Beluki/dir/blob/master/Source/game/hud.lua">Hud</a>, <a href="https://github.com/Beluki/dir/blob/master/Source/game/menu.lua">Menu</a>, <a href="https://github.com/Beluki/dir/blob/master/Source/game/screen.lua">Screen</a>, <a href="https://github.com/Beluki/dir/blob/master/Source/game/state.lua">State</a> y <a href="https://github.com/Beluki/dir/blob/master/Source/game/theme.lua">Theme</a> son los
módulos que se combinan para dar forma al juego final.</p>
<p>A más bajo nivel, cada módulo es responsable de sus propias animaciones.
Por ejemplo, Grid contiene todas las definiciones necesarias para que las piezas
del grid que están apareciendo, desapareciendo, moviéndose, etc mantengan su
estado entre frame y frame.</p>
<p>Un detalle importante aquí es que en <a href="https://github.com/Beluki/dir">dir</a> solo existe una animación a la vez
en todo el grid. No es posible tener piezas que se muevan, mientras otras desaparecen
al mismo tiempo. Esto simplifica mucho la implementación, porque puede hacerse en
base al concepto de "Tween", donde cada animación se enlaza con la siguiente a través
de una función puente (ver por ejemplo grid.appearing.oncomplete).</p>
<p>El hilo conductor final es <a href="https://github.com/Beluki/dir/blob/master/Source/game/state.lua">State</a>, que decide qué hacer en base al ranking y la
puntuación actuales, cada vez que las piezas cambian de estado.</p>
<p>Finalmente, en la carpeta <a href="https://github.com/Beluki/dir/tree/master/Source/lib">lib</a> hay dos pequeñas librerías. Una para manipular arrays
de dos dimensiones y otra con wrappers sobre la funcionalidad básica de Löve2D. Esta última
es totalmente prescindible, pero hará más fácil portar <a href="https://github.com/Beluki/dir">dir</a> a futuras versiones de Löve
si este cambia.</p>
<h2>Conclusiones</h2>
<p>Estoy muy orgulloso del resultado obtenido con <a href="https://github.com/Beluki/dir">dir</a>. Creo que el resultado ha merecido el
esfuerzo. El <a href="http://beluki.github.io/post/grandmaster">record</a> actual será además muy difícil de superar.</p>
<h2>Bonus</h2>
<p>Aquí puedes ver un vídeo de un usuario del foro de Löve2D jugando a dir:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/B6CJWG67TdE" frameborder="0" allowfullscreen>
</iframe>

<p>Y un port a Android:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/sUHYoeOMYGU" frameborder="0" allowfullscreen>
</iframe>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-dir/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-dir/#disqus_thread">comentarios</a>
        </div>
    
        


<div class="title">
    Cosas que aprendí de... MQLite
</div>

<div class="subtitle">
    diciembre 14, 2015

    <div class="multilink">
        
            <a href="/archive/postmortem/">postmortem</a>

             | 
        
            <a href="/archive/programacion/">programación</a>

             | 
        
            <a href="/archive/python/">python</a>

            
        
    </div>
</div>

<div class="content">
    <p><a href="https://github.com/Beluki/MQLite">MQLite</a> es un pequeño dialecto basado en <a href="http://wiki.freebase.com/wiki/MQL">MQL</a>, el lenguaje que se utiliza en
<a href="https://www.freebase.com">Freebase</a> para realizar búsquedas. Está escrito en Python 3 y es un compilador
sencillo a un <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> recursivo de nodos que implementan un método "match".</p>
<p>Aunque el núcleo de MQLite es un subset de MQL, en realidad implementa bastantes más
cosas que el original, debido a la necesidad de realizar búsquedas sobre <a href="https://en.wikipedia.org/wiki/JSON">JSON</a>
arbitrario en lugar de una base de datos concreta.</p>
<p>Como lo mejor es un ejemplo... El siguiente comando devuelve la lista de repositorios
que tengo en Github con al menos 1 fork activo.</p>
<div class="codehilite"><pre>$ curl https://api.github.com/users/Beluki/repos
<span class="p">|</span> MQlite.py <span class="s1">&#39;[{&quot;name&quot;: null, &quot;forks&quot;: null, &quot;forks &gt;&quot;: 0}]&#39;</span>
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;GaGa&quot;</span>,
        <span class="s2">&quot;forks&quot;</span>: 2
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;MQLite&quot;</span>,
        <span class="s2">&quot;forks&quot;</span>: 1
    <span class="o">}</span>
<span class="o">]</span>
</pre></div>


<h2>Arquitectura</h2>
<p>MQLite es un proyecto relativamente simple porque no necesita un parser. Utiliza la misma
sintaxis que JSON. Una vez tenemos los datos a buscar y un archivo .json donde buscarlos,
solo queda preprocesar la búsqueda para poder hacerla del modo más eficientemente posible.</p>
<p>Uno de los límites que me puse al implementarlo, es que MQLite nunca debería modificar
los datos JSON sobre los que busca, ni ordenándolos ni optimizándolos. Al fin y al cabo, si
realmente necesitas eso, te conviene más una base de datos real.</p>
<p>Si no podemos modificar los datos, solo queda representar la búsqueda. En el caso de MQLite,
está hecha a partir de una serie de nodos (objetos) con un método: "match" que devuelve o bien
una "respuesta" o "vacío" dependiendo de si los datos de la búsqueda coinciden con alguno
existente en la base de datos.</p>
<p>Como "None" es un resultado válido, "vacío" se representa con una clase propia:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">_NoMatch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom class to represent no matches.</span>
<span class="sd">    Needed because None is a legitimate match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="n">NoMatch</span> <span class="o">=</span> <span class="n">_NoMatch</span><span class="p">()</span>
</pre></div>


<p>Y "concuerda con cualquier cosa" se representa así:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">MatchAny</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match any input data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>


<p>La mayoría de nodos son sencillos. Cadenas, números o booleanos solo concuerdan consigo mismos.
Otros datos, como las listas o los diccionarios, permiten operaciones más complejas.</p>
<p>Un ejemplo de búsqueda una vez transformada a esta representación, podría ser:</p>
<div class="codehilite"><pre><span class="p">[{</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nt">&quot;age &gt;&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="nt">&quot;__sort__&quot;</span><span class="p">:</span> <span class="s2">&quot;age&quot;</span> <span class="p">}]</span>
</pre></div>


<p>Que queda así:</p>
<div class="codehilite"><pre><span class="n">MatchList</span><span class="p">(</span>
    <span class="n">MatchDict</span><span class="p">(</span>
        <span class="p">[{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">MatchAny</span><span class="p">()</span> <span class="p">}],</span>
        <span class="p">[{</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">ConstraintBiggerThan</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="p">}],</span>
        <span class="p">[{</span> <span class="s2">&quot;__sort__&quot;</span><span class="p">:</span> <span class="n">DirectiveSort</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span> <span class="p">}]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>


<p>Y significa:</p>
<p>Dame el nombre de todos los items en la base de datos que cumplan la condición de tener una edad
mayor de 25 e imprímelos en orden ascencente.</p>
<h2>Dificultades</h2>
<p>La parte más complicada de escribir MQLite fue con bastante diferencia encontrar una sintaxis
adecuada para expresar las búsquedas. En el <a href="https://github.com/Beluki/MQLite">README</a> hay numerosos ejemplos de búsquedas complejas
con directivas, constraints y todo tipo de opciones.</p>
<p>Dos limitaciones de MQLite son:</p>
<p>Es imposible escribir una cláusula "A o B" para dos claves distintas.</p>
<div class="codehilite"><pre><span class="p">[{</span> <span class="nt">&quot;a:age &gt;&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="nt">&quot;b:name in&quot;</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="p">}]</span>
</pre></div>


<p>Algunas directivas, en particular "__limit__", son sensibles al orden.</p>
<div class="codehilite"><pre><span class="p">[{</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nt">&quot;__sort__&quot;</span><span class="p">:</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="nt">&quot;__limit__&quot;</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}]</span>
</pre></div>


<p>Esta última búsqueda ordenará PRIMERO y limitará después en lugar de hacerlo al contrario.
En su API, MQLite usa <a href="https://docs.python.org/3/library/collections.html#collections.OrderedDict">OrderedDict</a> para asegurarse de mantener el orden correcto en cada
búsqueda (dado que los diccionarios de Python no garantizan un orden concreto).</p>
<h2>Compatibilidad con Python</h2>
<p>Aunque MQLite está pensado para JSON, puede buscar en prácticamente cualquier cosa iterable
de Python. Para hacerlo, basta con usar el objeto "Pattern" de la API en lugar de "JSONPattern".</p>
<div class="codehilite"><pre><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;James&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
        <span class="s2">&quot;student&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s2">&quot;hobbies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;chess&quot;</span><span class="p">,</span> <span class="s2">&quot;football&quot;</span><span class="p">,</span> <span class="s2">&quot;basketball&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
        <span class="s2">&quot;student&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s2">&quot;grades&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;chemistry&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;english&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span> <span class="p">},</span>
        <span class="s2">&quot;hobbies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;reading&quot;</span><span class="p">,</span> <span class="s2">&quot;swimming&quot;</span><span class="p">,</span> <span class="s2">&quot;painting&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">([{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;age in&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">])</span> <span class="p">}])</span>
<span class="k">print</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>


<p>Como añadido, MQLite incluye una <a href="https://raw.githubusercontent.com/Beluki/MQLite/master/Source/MQLiteSH.py">pequeña shell</a> para poder experimentar con distintas
búsquedas de manera rápida, explorar datasets, etc... También hay una suite de <a href="https://github.com/Beluki/MQLite/blob/master/Test/MQTest.py">tests</a> disponible.</p>
</div>


        <div class="multilink">
            <a href="/post/cosas-que-aprendi-de-MQLite/">permalink</a> |
            <a href="/post/cosas-que-aprendi-de-MQLite/#disqus_thread">comentarios</a>
        </div>
    

    
        <div class="prevnext">
            <ul>
                

                
                    <li> <a href="/2/">anterior &raquo;</a> </li>
                
            </ul>
        </div>
    

        </div>
    </body>
</html>
